

## webpack æ€§èƒ½ä¼˜åŒ–

## 1. ä¸»è¦é—®é¢˜

ç°åœ¨çš„ç³»ç»Ÿä¸»è¦å­˜åœ¨ä»¥ä¸‹å‡ ç‚¹æ¯”è¾ƒæ˜æ˜¾çš„é—®é¢˜ï¼š

- é¡µé¢é‡å®šå‘é€»è¾‘æœ‰è¯¯
- é¡µé¢åŠ è½½ç¼“æ…¢
- é¡¹ç›®å¯åŠ¨æ…¢ï¼Œæ„å»ºæ—¶é—´è¾ƒé•¿
- æ‰“åŒ…äº§ç‰©è¿‡å¤§

## 2. é—®é¢˜åˆ†æ

ä»¥ä¸‹é—®é¢˜çš„åˆ†æåŸºäº master ç¯å¢ƒ https://master-app.dmhub.cn/ ï¼Œå³å½“å‰çš„ 2.9 ç‰ˆæœ¬ã€‚

### 2.1 é¡µé¢é‡å®šå‘é€»è¾‘æœ‰è¯¯

å½“åœ¨æµè§ˆå™¨ä¸­è®¿é—®ç³»ç»Ÿå†…ä»»æ„ä¸€é¡µé¢ï¼Œåå°æœåŠ¡ä¼šè¿›è¡Œå½“å‰ç”¨æˆ· session æ˜¯å¦è¿‡æœŸçš„åˆ¤æ–­ï¼š

å¦‚æœ**ç™»å½•æœªè¿‡æœŸ**ï¼Œä¼šç›´æ¥åŠ è½½å½“å‰é¡µé¢ã€‚

å¦‚æœ**ç™»å½•è¿‡æœŸ**ï¼Œä»¥ https://master-app.dmhub.cn/ui/application/spa/index.html#/home ä¸ºä¾‹ï¼Œé¦–å…ˆä¼šåŠ è½½å½“å‰ html å†…çš„ç›¸å…³èµ„æºï¼Œå½“é¡µé¢è¢«åŠ è½½åˆ°æŸä¸€é˜¶æ®µï¼Œå¼€å§‹è¯·æ±‚æ¥å£æ—¶ï¼Œè¿™æ—¶æœåŠ¡ä¼šåˆ¤æ–­è¯¥ç”¨æˆ·ç™»å½•è¿‡æœŸï¼Œç„¶åæŠŠé¡µé¢é‡å®šå‘åˆ° https://master-app.dmhub.cn/ui/login.html ç™»å½•é¡µé¢ï¼Œè¿™æ—¶æ‰å¼€å§‹è¿›è¡Œç™»å½•é¡µçš„èµ„æºçš„åŠ è½½æ¸²æŸ“ï¼Œè®©ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

> 109 requests	8.4 MB transferred	21.4 MB resources

![image-20221125145009570](./images/image-20221125145009570.png)

å¦‚æœç›´æ¥åŠ è½½ login.html çš„èµ„æºè¯·æ±‚å¦‚ä¸‹ï¼š

> 19 requests	1.2 MB transferred	1.6 MB resources

![image-20221125143433415](./images/image-20221125143433415.png)

ç”±æ­¤å¯çœ‹å‡ºï¼Œå‰åèµ„æºåŠ è½½çš„å·®å¼‚ï¼Œæ‰€ä»¥ç”¨æˆ·ä¼šæ„Ÿåˆ°è¿™ä¸ªè¿‡ç¨‹éå¸¸çš„çš„ç¼“æ…¢ã€‚



### 2.2 é¡µé¢åŠ è½½ç¼“æ…¢

ä»¥é¦–é¡µ https://master-app.dmhub.cn/ui/application/spa/index.html#/home ä¸ºä¾‹ï¼Œå¹¶ç¦ç”¨ç¼“å­˜ï¼š

å½“è¿›å…¥ç³»ç»Ÿé¦–é¡µæˆ–è€…è¿›è¡Œé¡µé¢çš„åˆ·æ–°ï¼Œä¼šæ˜æ˜¾æ„Ÿè§‰åˆ°ç™½å±æ—¶é—´æ¯”è¾ƒé•¿ï¼Œé¡µé¢åŠ è½½ç¼“æ…¢ã€‚

#### 2.2.1 èµ„æºåŠ è½½åˆ†æ

ä»¥é¦–é¡µä¸ºä¾‹ï¼Œç½‘ç»œæ­£å¸¸ï¼ŒæœåŠ¡è¿”å›æ­£å¸¸çš„æƒ…å†µä¸‹ï¼š

> 155 requests	10.9 MB transferred	23.8 MB resources	Finish: 9.54 s	DOMContentLoaded: 1.22 s	Load: 5.21 s

- æ¥å£è¯·æ±‚æ•°ï¼š65 ä¸ªï¼Œä¼ è¾“ 104 KB
- JS è¯·æ±‚æ•°ï¼š71 ä¸ªï¼Œä¼ è¾“ 6.2 MBï¼ˆGzipï¼ŒåŸ 17.9 MBï¼‰
- CSS è¯·æ±‚æ•°ï¼š13 ä¸ªï¼Œä¼ è¾“ 244 KBï¼ˆGzipï¼ŒåŸ 1.2 MBï¼‰
- å­—ä½“æ•°ï¼š1 ä¸ªï¼Œä¼ è¾“ 4.3 MB

ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦æ˜¯ JS æ–‡ä»¶å’Œ Font æ¯”è¾ƒçš„å¤§ï¼Œå¤šä¸ª JS æ–‡ä»¶å‡è¶…è¿‡ 1MBï¼Œæœ€å¤§ 3MBã€‚å…¶æ¬¡ Chrome æµè§ˆå™¨åœ¨åŒä¸€åŸŸåä¸‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°æ˜¯ 6 ä¸ªï¼Œè¿‡å¤šçš„èµ„æºè¯·æ±‚ï¼Œä¹Ÿä¼šå¯¼è‡´èµ„æºåŠ è½½ç¼“æ…¢ã€‚æœ€åå°±æ˜¯å­˜åœ¨å¤§é‡æ¥å£çš„é‡å¤è¯·æ±‚ã€‚

#### 2.2.2 æ‰“åŒ…äº§ç‰©åˆ†æ

é€šè¿‡ `webpack-bundle-analyzer` å¯¹æ‰“åŒ…äº§ç‰©è¿›è¡Œåˆ†æï¼Œå¦‚ä¸‹å›¾ï¼š

![DM Hub UI Bundles](./images/WeChatWorkScreenshot_d217c35e-c754-45a1-9017-4b951936863a.png)

é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œbundles æ–‡ä»¶å…±è®¡ 40 MBï¼Œå¹¶ä¸”æœ‰éƒ¨åˆ†è¾ƒå¤§çš„ä¾èµ–ä¼šè¢«æ‰“åŒ…è¿›å»ï¼Œå¦‚æœç»“åˆä»£ç è¿›è¡Œåˆ†æçš„è¯ï¼Œä¼šå‘ç°æœ‰ä¸€éƒ¨åˆ†å·²ç»åºŸå¼ƒä½†æ˜¯ä»ç„¶è¢«æ‰“åŒ…äº†è¿›å»ã€‚å¦å¤–è¾ƒå¤§çš„ä¾èµ–åº”è¯¥ç§»å‡ºå•ç‹¬ç”Ÿæˆã€‚æ‰€ä»¥å¯ä»¥æ ¹æ®æ­¤å›¾ï¼Œé’ˆå¯¹æ€§çš„è¿›è¡Œè°ƒæ•´ã€‚

#### 2.2.3 åˆ†ææ€»ç»“

- **èµ„æºè¯·æ±‚æ•°è¿‡å¤š**ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç­‰å¾…ï¼Œéœ€è¦è¿›è¡Œæ‰“åŒ…ä¼˜åŒ–ï¼Œå‡å°‘èµ„æºè¾ƒå°çš„ JS å•ç‹¬æ‰“åŒ…å®Œä¸€ä¸ªæ–‡ä»¶ï¼ˆåŒ…æ‹¬ SVG Iconsï¼‰
- **JS æ‰“åŒ…èµ„æºè¿‡å¤§**ï¼Œéƒ¨åˆ†å•ä¸€ JS æ–‡ä»¶è¿‡å¤§ï¼ŒåŠ è½½æ—¶é—´é•¿ï¼Œå¯èƒ½å­˜åœ¨å¾ˆå¤šéå¿…è¦çš„åŠ è½½å’Œé‡å¤çš„æ‰“åŒ…ï¼Œéœ€è¦è¿›è¡Œæ‰“åŒ…ä¼˜åŒ–ä¸ª chunks åˆ†åŒ…
- **Font æ–‡ä»¶è¿‡å¤§**ï¼Œä¸­æ–‡å­—ä½“æœ¬èº«éƒ½æ¯”è¾ƒå¤§ï¼Œå¦‚æœè€ƒè™‘ç¼“å­˜çš„è¯å¯ä»¥å¿½ç•¥ï¼Œå¦åˆ™éœ€è¦è€ƒè™‘ä¼˜åŒ–
- **é‡å¤çš„æ¥å£è¯·æ±‚**ï¼Œä¼˜åŒ–ä»£ç é€»è¾‘ï¼ŒåŒä¸€æ¥å£åŠç›¸åŒå‚æ•°ä¸åº”è¯¥è¢«é‡å¤çš„è¯·æ±‚å¤šæ¬¡
- **æ— æ•ˆèµ„æºæ–‡ä»¶è¯·æ±‚ï¼Œæœ‰éƒ¨åˆ†é™æ€èµ„æºæ–‡ä»¶ï¼Œæˆ–è€…ä¾èµ–åŒ…å·²ç»ä¸å†ä½¿ç”¨ï¼Œéœ€è¦ç»“åˆä»£ç è¿›è¡Œæ¸…é™¤

### 2.3 æ„å»ºæ—¶é—´é•¿

é¡¹ç›®å¯åŠ¨æ…¢ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŸå› ï¼š

- webpack æ‰“åŒ…å™¨éœ€è¦è¿›è¡Œç›¸å…³é…ç½®çš„ä¼˜åŒ–
  - å‡å°‘éå¿…è¦çš„å…¥å£æ–‡ä»¶
  - å‡å°‘éå¿…è¦çš„ babel æ’ä»¶é…ç½®
  - å‡å°‘ webpck æ’ä»¶ï¼Œé’ˆå¯¹å¼€å‘ä¸ç”Ÿäº§ä¸åŒçš„ç¯å¢ƒé…ç½®å¯¹åº”çš„æ’ä»¶
  - ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ webpack ä¸ node
  - ä¼˜åŒ–å…¶ä»– webpack é…ç½®
  - å¼€å¯ç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- babel è½¬è¯‘å™¨è¾ƒæ…¢ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ swc æ›¿æ¢ä¼˜åŒ–

### 2.4 æ‰“åŒ…äº§ç‰©å¤§

æœ€è¿‘è¿›è¡Œå¾®å‰ç«¯æ”¹é€ ï¼ŒæŠŠä¸€ä¸ªæ¨¡å—æ”¹é€ æˆå¾®åº”ç”¨ï¼Œè¿™ä¸ªæ¨¡å—çš„ä»£ç é‡æœ¬èº«ä¸å¤§ï¼Œå¤§æ¦‚åªæœ‰ 160 KBï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„äº§å“æœ‰ 20MB +ã€‚

- åŸºç¡€åº“å¼€å¯ tree sharkingï¼Œå¦‚æœ package.json æœªé…ç½® sideEffect: falseï¼Œæ‰“åŒ…å·¥å…·ä¸ä¼šè¿›è¡Œ tree sharking
- MF çš„ Shared å…³é—­ï¼Œè¢« MF Shared çš„ç»„ä»¶åº“ï¼Œä¸ä¼šè¢« tree sharking
- è°ƒæ•´ä½¿ç”¨ import * çš„åœ°æ–¹ï¼Œè¢« import * çš„ç»„ä»¶åº“ï¼Œç„¶ååŠ¨æ€ä½¿ç”¨ï¼Œä¹Ÿä¸ä¼šè¢« tree sharking

## 3. å…·ä½“ä¼˜åŒ–

### 3.1 ç™»å½•é¡µ

#### 3.1.1 æœåŠ¡ç«¯é‡å®šå‘é€»è¾‘ä¼˜åŒ–

ä»ä¸Šè¿°è¯·æ±‚æ–¹å¼å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥è®¿é—®ç™»å½•é¡µæ¯”è®¿é—®å…¶ä»–è·¯å¾„è·³è½¬ç™»å½•é¡µçš„èµ„æºå¤§å°è¦å°‘è¿‘ 10 MBï¼Œè¿™ä¸ªåœ¨æ…¢ç½‘æƒ…å†µä¸‹åŠ è½½æ—¶é•¿ä¼šæœ‰å¾ˆå¤§çš„å·®å¼‚ã€‚

å…¶ä¸»è¦åŸå› æ˜¯åç«¯ä¼šå…ˆæŠŠè¯·æ±‚é‡å®šå‘åˆ° index.htmlï¼Œæ­¤æ—¶éšç€ index.html æ–‡ä»¶çš„åŠ è½½ï¼Œä¼šä¸‹è½½å¤§é‡çš„èµ„æºã€‚å½“åŠ è½½å®Œæˆå¼€å§‹è¿›è¡Œè¯·æ±‚çš„æ¥å£ï¼Œæ­¤æ—¶åç«¯ä¼šåˆ¤æ–­ç”¨æˆ·æœªç™»å½•ï¼Œå†æ¬¡è¢«é‡å®šå‘åˆ°ç™»å½•é¡µã€‚

è§£å†³æ–¹æ³•å°±æ˜¯éœ€è¦åç«¯å…ˆåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœæœªç™»å½•ï¼Œç›´æ¥é‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¦åˆ™ç»§ç»­è¯·æ±‚å½“å‰é¡µé¢ã€‚

#### 3.1.2 èµ„æºè¯·æ±‚ä¼˜åŒ–

##### 3.1.2.1 å›¾ç‰‡

å›¾ç‰‡èµ„æºä¸­å­˜åœ¨ä¸€ä¸ªè¾ƒå¤§çš„èƒŒæ™¯å›¾ï¼ŒGzip å‹ç¼©åä»æœ‰ 170 KB çš„å¤§å°

![image-20221125151917597](./images/image-20221125151917597.png)

##### 3.1.2.2 æ ·å¼

é€šè¿‡ä¸‹é¢é€æ­¥åˆ†æå„ä¸ªæ ·å¼æ–‡ä»¶ï¼š

- **ant.cssï¼ˆ91.0 KB/530 KBï¼‰**ï¼Œé€šè¿‡ä»£ç åˆ†æï¼ŒåŠ Blocked ant.css æ–‡ä»¶ï¼Œå‘ç°å¯¹é¡µé¢æ— ä»»ä½•å½±å“ï¼Œå³æ ¹æœ¬æœªå¼•ç”¨åˆ° ant.css ä¸­çš„æ ·å¼ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ï¼›
- **ui-components cssï¼ˆ104 KB/584 KBï¼‰**ï¼Œæœ¬è´¨ä¸Šç™»å½•é¡µåªç”¨åˆ°äº†è¿™ä¸ªæ–‡ä»¶ä¸­çš„å‡ ä¸ª CSS å˜é‡ï¼Œä½†æ˜¯å´å°†æ•´ä¸ªæ–‡ä»¶å¼•å…¥è¿›æ¥ï¼Œé€ æˆäº†èµ„æºè¯·æ±‚æµªè´¹ï¼Œå¯ä»¥é’ˆå¯¹è¯¥æ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œå‰”é™¤æ— æ•ˆå†…å®¹ã€‚
- **clion.cssï¼ˆ12.3 KB/3.1 KBï¼‰**ï¼Œå­—ä½“å›¾æ ‡åº“ï¼Œå·²ç»ä¸å†ä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ã€‚

![image-20221125152054319](./images/image-20221125152054319.png)



### 3.2 Webpack

ä¼˜åŒ–å‰æ„å»ºæ—¶é•¿ï¼š280123 ms		ä¼˜åŒ–åæ„å»ºæ—¶é•¿ï¼š167610 ms

ä¼˜åŒ–å‰ chunk æ€»å¤§å°ï¼š39M				 ä¼˜åŒ–å chunk æ€»å¤§å°ï¼š

ä¼˜åŒ–å‰æœ€å¤§ chunk å¤§å°ï¼š19.2M				 ä¼˜åŒ–å chunk æ€»å¤§å°ï¼š

#### 3.2.1 å‡å°‘å…¥å£æ–‡ä»¶ entry

ç”±ä¹‹å‰çš„ 9 ä¸ªå…¥å£å‡å°‘åˆ° 6 ä¸ªå…¥å£

##### 3.2.1.1 public æ–‡ä»¶å¤¹ä¸‹çš„é™æ€èµ„æºæ‰“åŒ…

ä¼˜åŒ–ä¹‹å‰ï¼Œpublic ä¸‹æ‰€ä»¥çš„é™æ€èµ„æºç»Ÿä¸€ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å…¥å£è¿›è¡Œæ‰“åŒ…

ä¼˜åŒ–ä¹‹åï¼Œä½¿ç”¨ copy-webpack-plugin æ‹·è´åˆ°è¾“å‡ºç›®å½•ä¸‹ï¼Œä¸ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ‰“åŒ…å…¥å£

##### 3.2.1.2 i18n.js

ä¼˜åŒ–ä¹‹å‰ï¼Œi18n.js ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å…¥å£æ–‡ä»¶è¿›è¡Œæ‰“åŒ…

ä¼˜åŒ–ä¹‹åï¼Œå°† i18n.js æ‹·è´åˆ° public ä¸‹ï¼Œä¸ä½œä¸ºä¸€ä¸ªæ‰“åŒ…å…¥å£

##### 3.2.1.3 åˆ é™¤/åˆå¹¶ compileMap.js ä¸­ä¸å†ä½¿ç”¨çš„å…¥å£æ–‡ä»¶

1. WeChat/transfer ä¸å†ä½¿ç”¨ï¼Œåˆ é™¤
2. åˆå¹¶é¦–é¡µ -> spa åŒä¸€ä¸ªè·¯ç”±ä¸‹ï¼ˆå¾…å®šï¼‰
3. ç§»åŠ¨ login.js å’Œ login.html åˆ° public ä¸‹ï¼Œä¸ä½œä¸ºæ‰“åŒ…å…¥å£ï¼ˆå¾…å®šï¼‰
4. åˆå¹¶ invitationã€invitationV2 åˆ° spa è·¯ç”±ä¸‹ï¼Œä¸ä½œä¸ºæ‰“åŒ…å…¥å£ï¼ˆå¾…å®šï¼‰
5. åˆ é™¤ dependencies å…¥å£ï¼Œéƒ½é€šè¿‡ webpack æ‰“åŒ…å’Œ tree shaking



#### 3.2.2 å‡å°‘ webpack çš„ plugin å’Œ loader



#### 3.2.3 æ›´æ–° webpack åŠ node åˆ°æœ€æ–°ç‰ˆæœ¬

é¿å…ä½¿ç”¨ç”Ÿäº§/å¼€å‘ç¯å¢ƒä¸‹æ‰éœ€è¦ç”¨çš„å·¥å…·ï¼Œç”¨åˆ°äº†å…¶ä»–ç¯å¢ƒ



#### 3.2.4 ä¼˜åŒ– webpack é…ç½®é¡¹

##### 3.2.4.1 outpu.pathinfo è®¾ç½® false

##### 3.2.4.2 resolve.extensions é…ç½®

å½“æ¨¡å—å¯¼å…¥è¯­å¥æœªæºå¸¦æ–‡ä»¶åç¼€æ—¶ï¼Œå¦‚ `import './a'` ï¼ŒWebpack ä¼šéå† `resolve.extensions` é¡¹å®šä¹‰çš„åç¼€ååˆ—è¡¨ï¼Œå°è¯•åœ¨ `'./a'` è·¯å¾„è¿½åŠ åç¼€åï¼Œæœç´¢å¯¹åº”ç‰©ç†æ–‡ä»¶ã€‚

åœ¨ Webpack 5 ä¸­ï¼Œ`resolve.extensions` é»˜è®¤å€¼ä¸º `['.js', '.json', '.wasm']` ï¼Œè¿™æ„å‘³ç€ Webpack åœ¨é’ˆå¯¹ä¸å¸¦åç¼€åçš„å¼•å…¥è¯­å¥æ—¶å¯èƒ½éœ€è¦æ‰§è¡Œä¸‰æ¬¡åˆ¤æ–­é€»è¾‘æ‰èƒ½å®Œæˆæ–‡ä»¶æœç´¢ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå¯è¡Œçš„ä¼˜åŒ–æªæ–½åŒ…æ‹¬ï¼š

- è°ƒæ•´é¡ºåºï¼Œé¢‘ç‡å‡ºç°æœ€é«˜çš„æ–‡ä»¶åç¼€è¦ä¼˜å…ˆæ”¾åœ¨æœ€å‰é¢ï¼Œä»¥åšåˆ°å°½å¿«çš„é€€å‡ºå¯»æ‰¾è¿‡ç¨‹
- åç¼€å°è¯•åˆ—è¡¨è¦å°½å¯èƒ½çš„å°ï¼Œä¸è¦æŠŠé¡¹ç›®ä¸­ä¸å¯èƒ½å­˜åœ¨çš„æƒ…å†µå†™åˆ°åç¼€å°è¯•åˆ—è¡¨ä¸­

- ä¿®æ”¹ `resolve.extensions` é…ç½®é¡¹ï¼Œå‡å°‘åŒ¹é…æ¬¡æ•°

- ä»£ç ä¸­å°½é‡è¡¥é½æ–‡ä»¶åç¼€åï¼Œæ¯”å¦‚ data.json ç±»ä¼¼çš„æ–‡ä»¶ï¼Œéƒ½è¡¥é½ .json åç¼€å
- è®¾ç½® `resolve.enforceExtension = true` ï¼Œå¼ºåˆ¶è¦æ±‚å¼€å‘è€…æä¾›æ˜ç¡®çš„æ¨¡å—åç¼€åï¼Œè¿™ç§åšæ³•ä¾µå…¥æ€§å¤ªå¼ºï¼Œä¸å¤ªæ¨è

##### 3.2.4.3 resolve.modules é…ç½®

å½“ Webpack é‡åˆ° `import 'lodash'` è¿™æ ·çš„ npm åŒ…å¯¼å…¥è¯­å¥æ—¶ï¼Œä¼šå°è¯•å…ˆå½“å‰é¡¹ç›®çš„ `node_modules` æœç´¢èµ„æºï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™æŒ‰ç›®å½•å±‚çº§å°è¯•é€çº§å‘ä¸ŠæŸ¥æ‰¾ `node_modules` ç›®å½•ï¼Œå¦‚æœä¾ç„¶æ‰¾ä¸åˆ°åˆ™æœ€ç»ˆå°è¯•åœ¨å…¨å±€ `node_modules` ä¸­æœç´¢ã€‚

åœ¨ä¸€ä¸ªä¾èµ–ç®¡ç†æ‰§è¡Œçš„æ¯”è¾ƒè‰¯å¥½çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°½é‡ä¿æŒ `node_modules` èµ„æºçš„é«˜åº¦å†…èšï¼Œæ§åˆ¶åœ¨æœ‰é™çš„ä¸€ä¸¤ä¸ªå±‚çº§ä¸Šï¼Œå› æ­¤ Webpack è¿™ä¸€é€å±‚æŸ¥æ‰¾çš„é€»è¾‘å¤§å¤šæ•°æƒ…å†µä¸‹å®ç”¨æ€§å¹¶ä¸é«˜ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ä¿®æ”¹ `resolve.modules` é…ç½®é¡¹ï¼Œä¸»åŠ¨å…³é—­é€å±‚æœç´¢åŠŸèƒ½ã€‚

##### 3.2.4.4 resolve.mainFiles é…ç½®

ä¸ `resolve.extensions` ç±»ä¼¼ï¼Œ`resolve.mainFiles` é…ç½®é¡¹ç”¨äºå®šä¹‰æ–‡ä»¶å¤¹é»˜è®¤æ–‡ä»¶åï¼Œä¾‹å¦‚å¯¹äº `import './dir'` è¯·æ±‚ï¼Œå‡è®¾ `resolve.mainFiles = ['index', 'home']` ï¼ŒWebpack ä¼šæŒ‰ä¾æ¬¡æµ‹è¯• `./dir/index` ä¸ `./dir/home` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚

å› æ­¤ï¼Œå®é™…é¡¹ç›®ä¸­åº”æ§åˆ¶ `resolve.mainFiles` æ•°ç»„æ•°é‡ï¼Œå‡å°‘åŒ¹é…æ¬¡æ•°ã€‚

##### 3.2.4.5 noParse è·³è¿‡æ–‡ä»¶ç¼–è¯‘

æœ‰ä¸å°‘ npm åŒ…é»˜è®¤æä¾›äº†æå‰æ‰“åŒ…å¥½ï¼Œä¸éœ€è¦åšäºŒæ¬¡ç¼–è¯‘çš„èµ„æºç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š

- Vue åŒ…çš„ `node_modules/vue/dist/vue.runtime.esm.js` æ–‡ä»¶
- React åŒ…çš„ `node_modules/react/umd/react.production.min.js` æ–‡ä»¶

å¯¹ä½¿ç”¨æ–¹æ¥è¯´ï¼Œè¿™äº›èµ„æºç‰ˆæœ¬éƒ½æ˜¯é«˜åº¦ç‹¬ç«‹ã€å†…èšçš„ä»£ç ç‰‡æ®µï¼Œæ²¡å¿…è¦é‡å¤åšä¾èµ–è§£æã€ä»£ç è½¬è¯‘æ“ä½œï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ `module.noParse` é…ç½®é¡¹è·³è¿‡è¿™äº› npm åŒ…ï¼Œä¾‹å¦‚ï¼š

```js
// webpack.config.js
module.exports = {
  //...
  module: {
    noParse: /vue|lodash|react/,
  },
};
```

é…ç½®è¯¥å±æ€§åï¼Œä»»ä½•åŒ¹é…è¯¥é€‰é¡¹çš„åŒ…éƒ½ä¼šè·³è¿‡è€—æ—¶çš„åˆ†æè¿‡ç¨‹ï¼Œç›´æ¥æ‰“åŒ…è¿› chunkï¼Œæå‡ç¼–è¯‘é€Ÿåº¦ã€‚

##### 3.2.4.6 æœ€å°åŒ– Loader ä½œç”¨èŒƒå›´

Loader ç»„ä»¶ç”¨äºå°†å„å¼æ–‡ä»¶èµ„æºè½¬æ¢ä¸ºå¯è¢« JavaScript ç†è§£ã€è¿è¡Œçš„ä»£ç ç‰‡æ®µï¼Œæ­£æ˜¯è¿™ä¸€ç‰¹æ€§æ”¯æ’‘èµ· Webpack å¼ºå¤§çš„èµ„æºå¤„ç†èƒ½åŠ›ã€‚ä¸è¿‡ï¼ŒLoader åœ¨æ‰§è¡Œå†…å®¹è½¬æ¢çš„è¿‡ç¨‹å¯èƒ½éœ€è¦åšå¤§é‡çš„ CPU è¿ç®—æ“ä½œï¼Œä¾‹å¦‚ babel-loaderã€eslint-loaderã€vue-loader ç­‰ï¼Œå› æ­¤å¼€å‘è€…æœ‰å¿…è¦æ ¹æ®å®é™…éœ€æ±‚ï¼Œé€šè¿‡ `module.rules.include`ã€`module.rules.exclude` ç­‰é…ç½®é¡¹é™å®š Loader çš„æ‰§è¡ŒèŒƒå›´ï¼Œä¾‹å¦‚ï¼š

```js
// webpack.config.js
module.exports = {
    // ...
    module: {
        rules: [{
            test: /\.js$/,
            exclude: /node_modules/,
            // include: path.join(__dirname, './src'),
            use: ['babel-loader', 'eslint-loader']
        }]
    }
};
```

ç¤ºä¾‹é…ç½® `exclude: /node_modules/` å±æ€§åï¼ŒWebpack åœ¨å¤„ç† `node_modules` ä¸­çš„ js æ–‡ä»¶æ—¶ä¼šç›´æ¥è·³è¿‡è¿™ä¸ª `rule` é¡¹ï¼Œä¸ä¼šä¸ºè¿™äº›æ–‡ä»¶æ‰§è¡Œåç»­çš„ Loaderã€‚

##### 3.2.4.7 æœ€å°åŒ– watch ç›‘æ§èŒƒå›´

åœ¨ watch æ¨¡å¼ä¸‹(é€šè¿‡ `npx webpack --watch` å‘½ä»¤å¯åŠ¨)ï¼ŒWebpack ä¼šæŒç»­ç›‘å¬é¡¹ç›®æ‰€æœ‰ä»£ç æ–‡ä»¶ï¼Œå‘ç”Ÿå˜åŒ–æ—¶é‡æ–°æ„å»ºæœ€æ–°äº§ç‰©ã€‚ä¸è¿‡ï¼Œé€šå¸¸æƒ…å†µä¸‹å‰ç«¯é¡¹ç›®ä¸­æŸäº›èµ„æºå¹¶ä¸ä¼šé¢‘ç¹æ›´æ–°ï¼Œä¾‹å¦‚ `node_modules` ï¼Œæ­¤æ—¶å¯ä»¥è®¾ç½® `watchOptions.ignored` å±æ€§å¿½ç•¥è¿™äº›æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

```js
// webpack.config.js
module.exports = {
  //...
  watchOptions: {
    ignored: /node_modules/
  },
};
```

##### 3.2.4.8 è·³è¿‡ TS ç±»å‹æ£€æŸ¥

JavaScript æœ¬èº«æ˜¯ä¸€é—¨å¼±ç±»å‹è¯­è¨€ï¼Œè¿™åœ¨å¤šäººåä½œé¡¹ç›®ä¸­ç»å¸¸ä¼šå¼•èµ·ä¸€äº›ä¸å¿…è¦çš„ç±»å‹é”™è¯¯ï¼Œå½±å“å¼€å‘æ•ˆç‡ã€‚éšå‰ç«¯èƒ½åŠ›ä¸èŒèƒ½èŒƒå›´çš„ä¸æ–­æ‰©å±•ï¼Œå‰ç«¯é¡¹ç›®çš„å¤æ‚æ€§ä¸åä½œéš¾åº¦ä¹Ÿåœ¨ä¸æ–­ä¸Šå‡ï¼ŒTypeScript æ‰€æä¾›çš„é™æ€ç±»å‹æ£€æŸ¥èƒ½åŠ›ä¹Ÿå°±è¢«è¶Šæ¥è¶Šå¤šäººæ‰€é‡‡çº³ã€‚

ä¸è¿‡ï¼Œç±»å‹æ£€æŸ¥æ¶‰åŠ AST è§£æã€éå†ä»¥åŠå…¶å®ƒéå¸¸æ¶ˆè€— CPU çš„æ“ä½œï¼Œä¼šç»™å·¥ç¨‹åŒ–æµç¨‹å¼•å…¥æ€§èƒ½è´Ÿæ‹…ï¼Œå¿…è¦æ—¶å¼€å‘è€…å¯é€‰æ‹©å…³é—­ç¼–è¯‘ä¸»è¿›ç¨‹ä¸­çš„ç±»å‹æ£€æŸ¥åŠŸèƒ½ï¼ŒåŒæ­¥ç”¨ `fork-ts-checker-webpack-plugin` æ’ä»¶å°†å…¶å‰¥ç¦»åˆ°å•ç‹¬è¿›ç¨‹æ‰§è¡Œï¼Œä¾‹å¦‚å¯¹äº `ts-loader`ï¼š

```js
const ForkTsCheckerWebpackPlugin = require('fork-ts-checker-webpack-plugin');

module.exports = {
  // ...
  module: {
    rules: [{
      test: /\.ts$/,
      use: [
        {
          loader: 'ts-loader',
          options: {
            transpileOnly: true
          }
        }
      ],
    }, ],
  },
  plugins:[
    new ForkTsCheckerWebpackPlugin()
  ]
};
```

##### 3.2.4.9 æ…ç”¨ source-map

`source-map` æ˜¯ä¸€ç§å°†ç»è¿‡ç¼–è¯‘ã€å‹ç¼©ã€æ··æ·†çš„ä»£ç ä»£ç æ˜ å°„å›æºç çš„æŠ€æœ¯ï¼Œå®ƒèƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…è¿…é€Ÿå®šä½åˆ°æ›´æœ‰æ„ä¹‰ã€æ›´ç»“æ„åŒ–çš„æºç ä¸­ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚ä¸è¿‡ï¼ŒåŒæ ·çš„ `source-map` æ“ä½œæœ¬èº«ä¹Ÿæœ‰å¾ˆå¤§æ€§èƒ½å¼€é”€ï¼Œå»ºè®®è¯»è€…æ ¹æ®å®é™…åœºæ™¯æ…é‡é€‰æ‹©æœ€åˆé€‚çš„ `source-map` æ–¹æ¡ˆã€‚

é’ˆå¯¹ `source-map` åŠŸèƒ½ï¼ŒWebpack æä¾›äº† `devtool` é€‰é¡¹ï¼Œå¯ä»¥é…ç½® `eval`ã€`source-map`ã€`cheap-source-map` ç­‰å€¼ï¼Œä¸è€ƒè™‘å…¶å®ƒå› ç´ çš„æƒ…å†µä¸‹ï¼Œæœ€ä½³å®è·µï¼š

- å¼€å‘ç¯å¢ƒä½¿ç”¨ `eval` ï¼Œç¡®ä¿æœ€ä½³ç¼–è¯‘é€Ÿåº¦
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `source-map`ï¼Œè·å–æœ€é«˜è´¨é‡

##### 3.2.4.10 module.rules.oneof ä¼˜åŒ– loader åŒ¹é…

#### 3.2.5 åˆ é™¤éå¿…è¦çš„ babel æ’ä»¶

- @jacklu/i18nï¼Œé¡¹ç›®ä¸­æš‚æ—¶æœªæ‰¾åˆ°æ”¹æ’ä»¶ğŸš—
- @babel/plugin-proposal-nullish-coalescing-operatorï¼Œ@babel/preset-env å·²ç»åŒ…å«ï¼Œéœ€è¦é…ç½®è¯¥æ’ä»¶ğŸš—
- react-dev-inspector/plugins/babelï¼Œæš‚æ—¶å…ˆç»™åˆ é™¤ğŸš—

### 3.3 åˆ å‡ package åŒ…

#### 3.3.1 `externals` é…ç½®æ›¿æ¢ä¸º `splitChunks.cacheGroups`

> `externals` æ˜¯é˜²æ­¢å°†æŸäº› `import` çš„åŒ…(package)æ‰“åŒ…åˆ° bundle ä¸­ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶(runtime)å†å»ä»å¤–éƒ¨è·å–è¿™äº›*æ‰©å±•ä¾èµ–(external dependencies)*ã€‚ä¸»è¦æ˜¯ç”¨äºå¼€å‘ `library` ã€‚

åœ¨ DM Hub UI ä¸­ï¼Œä¼šæŠŠæ‰€æœ‰ä¸éœ€è¦æ‰“åŒ…åˆ° bundle ä¸­çš„åŒ…å…¨éƒ¨éƒ½å…ˆ `externals` ä¸­ï¼Œç„¶åæŠŠè¿™äº›åŒ…çš„ä»£ç å¼•å…¥åˆ° html ä¸­ï¼Œè¿™æ ·ä¼šå¯¼è‡´åœ¨åŠ è½½è¯¥ HTML é¡µé¢çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™äº› JS æ–‡ä»¶å…¨éƒ¨éƒ½ä¸‹è½½åˆ°æµè§ˆå™¨ä¸­ï¼Œå®é™…æƒ…å†µä¸­æŸäº›è·¯ç”±å¹¶ä¸éœ€è¦è¿™äº› JSï¼Œåè€Œå…¨éƒ¨éƒ½åŠ è½½äº†ã€‚è¿™æ ·ä¸»è¦ä¼šé€ æˆé¦–æ¬¡åŠ è½½é¡µé¢çš„æ—¶é•¿å˜å¤šã€‚

> `splitChunks.cacheGroups` å¯ä»¥æ ¹æ®åŒ¹é…æ¡ä»¶åŠè§„åˆ™ï¼ŒæŠŠæŸäº›åŒ…å•ç‹¬æ‰“åŒ…æˆä¸€ä¸ª chunk æ–‡ä»¶ï¼Œè¿™äº› chunks æ–‡ä»¶ä¸ä¼šéš html ç«‹å³è¢«ä¸‹è½½ï¼Œè€Œæ˜¯åœ¨éœ€è¦çš„è·¯ç”±é¡µé¢åŠ¨æ€çš„å»åŠ è½½ã€‚

é€šè¿‡ `splitChunks.cacheGroups` å¯ä»¥å‡å°‘é¦–æ¬¡åŠ è½½éå¿…è¦çš„ js æ–‡ä»¶çš„ä¸‹è½½ï¼Œä»è€Œæå‡é¡µé¢çš„åŠ è½½é€Ÿåº¦ã€‚å½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¾èµ–åŒ…éƒ½éœ€è¦è¢«å•ç‹¬æ‰“åŒ…æˆ chunkï¼Œå¯ä»¥è®¾å®šåŒ…çš„å¤§å°è¿›è¡ŒåŒ¹é…ï¼Œæˆ–è€…é€šè¿‡ https://bundlephobia.com/ æŸ¥è¯¢ä¾èµ–çš„å¤§å°è¿›è¡Œé…ç½®ï¼Œä¸‹é¢æ˜¯ä¸€äº›éœ€è¦é…ç½®çš„åŒ…ï¼š

- bizchartsï¼ŒMinified 1.6 MBï¼ŒMinified + Gzipped 420.9 KB
- echartsï¼ŒMinified 1 MBï¼ŒMinified + Gzipped 324.6 KB
- xlsxï¼ŒMinified 412 KBï¼ŒMinified + Gzipped 135.5 KB
- @antv/g2ï¼ŒMinified 646 KBï¼ŒMinified + Gzipped 174.9 KB
- momentï¼ŒMinified 290.4 KBï¼ŒMinified + Gzipped 72.1 KB
- ahooksï¼ŒMinified 172.5 KBï¼ŒMinified + Gzipped 54.8 KB



#### 3.3.2 åˆ é™¤æ— ç”¨çš„ä¾èµ–åŒ…

- `ali-oss`ï¼Œä»£ç ä¸­æœ‰å¯¼å…¥ï¼Œä½†æ˜¯å®é™…æ–¹æ³•æœªè¢«å¼•ç”¨ï¼Œå¯ä»¥åˆ é™¤ï¼Œå¤§å° 512.94 KB
- `react-router`ï¼Œç°åœ¨å·²ç»å…¨éƒ¨æ›¿æ¢ä¸º `react-router-dom` äº†ï¼Œæ‰€ä»¥æ­¤åŒ…å¯ä»¥ç§»é™¤
- finally-pllyfillï¼Œæµè§ˆå™¨å·²ç»æ”¯æŒ Promise.prototype.finallyï¼Œæ‰€ä»¥æ— éœ€å®‰è£…æ­¤åŒ…

