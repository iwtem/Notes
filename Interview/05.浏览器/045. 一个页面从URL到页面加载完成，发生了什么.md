## 页面从 URL 到页面加载完成，发生了什么？

主要分为以下过程：

1. 输入网址URL
2. 缓存机制
3. DNS解析
4. TCP连接
5. 发送http请求
6. 接受响应，判断状态码选择处理方式
7. 判断缓存
8. 解码
9. 渲染
10. 连接结束



### 1. 输入网址 URL

端口默认为80，一共有6要素:协议，域名，路径，查询参数，锚点，端口。



### 2. 缓存机制

将URL与缓存进行比对如果请求的页面在缓存中且未过期，则直接进行**第7步**。

#### 2.1 彻底缓存

- Expires是一个绝对时间，即服务器时间。浏览器检查当前时间，如果还没到失效时间就直接使用缓存文件。但是该方法存在一个问题：服务器时间与客户端时间可能不一致。因此该字段已经很少使用，现在基本用cache-control进行判断。

- cache-control中的max-age保存一个相对时间。例如Cache-Control: max-age = 484200，表示浏览器收到文件后，缓存在484200s内均有效。 如果同时存在cache-control和Expires，浏览器总是优先使用cache-control。

#### 2.2 缓存协商

当缓存过期时，浏览器会向服务器发起请求询问资源是否真正过期，这就是缓存协商。对应http首部字段：last-modified，Etag

- last-modified是第一次请求资源时，服务器返回的字段，表示最后一次更新的时间。下一次浏览器请求资源时就发送if-modified-since字段。服务器用本地Last-modified时间与if-modified-since时间比较，如果不一致则认为缓存已过期并返回新资源给浏览器；如果时间一致则发送304状态码，让浏览器继续使用缓存。当然，用该方法也存在问题，比如修改时间有变化但实际内容没有变化，而服务器却再次将资源发送给浏览器。所以，使用Etag进行判断更好。

- Etag：资源的实体标识（哈希字符串），当资源内容更新时，Etag会改变。服务器会判断Etag是否发生变化，如果变化则返回新资源，否则返回304。

> 缓存协商的过程需要发起一起HTTP请求，如果返回304则继续使用缓存。对于移动端一次请求还是有代价的，所以我们需要避免304。

> 对于很少进行更改的静态文件，可以在文件名中加入版本号，如get.v1.js，并且把Cache-Control的max-age设置成一年半载，这样就不会发送请求。
> 需要注意的是，当这些文件更新的时候，我们需要更新其版本号，这样浏览器才会到服务器下载新资源。

![Cache](./images/cache.jpeg)



### 3. DNS 解析

由于ip比较难记，所以一般输入域名，通过dns解析得到ip。

網域名称系统（英文：Domain Name System，缩写：**DNS**）是互联网的一项服务。它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。

**DNS查找缓存顺序：浏览器缓存——>hosts文件——>路由器缓存——>网络服务商缓存——>根域名服务器缓存**



### 4. TCP 连接

得到 ip 地址后，知道了服务器的 IP 地址，下面便开始与服务器建立连接了。



TCP是互联网中的传输层协议，提供可靠的链接服务，采用三次握手确认一个连接：

1. 浏览器向服务器发送建立连接的请求。

2. 服务器接收到浏览器发送的请求后，想浏览器发送统一连接的信号。

3. 浏览器接受到服务器发出的同意连接的信号后，再次向服务器发出确认连接的信号。

当三次握手返程，TCP客户端和服务端成功的建立连接，就可以开始传输数据了。

**第三次是防止了服务器端的一直等待而浪费资源**



### 5. HTTP 请求

浏览器会开始构造一个**应用层**的 http 请求，把**传输层**tcp 包被封到**网络层**的 ip 包里面，ip 包再被封装到**数据链路层**的数据帧结构中，再通过**物理层**的比特流送出去。



### 6. 处理请求

浏览器接受 HTTP 响应，检查 HTTP header 里的状态码，并做出不同的处理方式

比如404显示错误页面，304使用缓存，200下一步解码和渲染， 204页面不会发生更新。



### 7. 判断缓存

如果是可以缓存的，这个响应则会被存储起来

根据首部字段判断是否进行缓存。例如，Cache-Control, no-cache(每次使用缓存前和服务器确认)，no-store 绝对禁止缓存。



### 8. 解码

浏览器拿到index.html文件后，就开始解析其中的html代码，遇到js/css/image等静态资源时，就向服务器端去请求下载

解析成对应的树形数据结构DOM树、CSS规则树，Javascript脚本通过DOM API和CSSOM API来操作DOM树、CSS规则树。



### 9. 渲染

1. 计算CSS样式（JS可动态修改dom或css,进一步改变渲染树和分布）

2. 建渲染树（Repaint：屏幕的一部分要重画，比如某个CSS的背景色变了，元素的几何尺寸没有变。Reflow：几何尺寸变了，我们需要重新验证并计算Render Tree。）

3. 确认布局（定位坐标和大小，是否换行，各种position, overflow, z-index属性 ……）

4. 绘制（调用操作系统Native GUI的API绘制，将每个节点转化为实际像素绘制到视口上）



### 10.断开连接--四次挥手

四次挥手的过程：

1. 主机向服务器发送一个断开连接的请求（不早了，我该走了）；
2. 服务器接到请求后发送确认收到请求的信号（知道了）；
3. 服务器向主机发送断开通知（我也该走了）；
4. 主机接到断开通知后断开连接并反馈一个确认信号（嗯，好的），服务器收到确认信号后断开连接；